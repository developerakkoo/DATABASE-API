// path to fileserver is set once in js and once in html
window.addEventListener('load', ()=>{
  setupDragndrop()
  $.ajax('/fileserver/directory?path=' + ($.query.path || '/')).get()
    .then(dir => listDownloads(dir.files)
        , err => {})
})

let files

function setupDragndrop() {

  function listUploads(files) {
    let cont_uploads = $('#uploads')
    cont_uploads.innerHTML = ''
    console.log('files added:', files)
    for (let file of files) {
      let elFile = $.html(cont_uploads, `
        <div class="file">
          <span class="progress"></span>
          <div class="name">${file.filepath}</div>
          <div class="size">${file.size}</div>
          <div><a>delete</a></div>
        </div>
      `)
      file.progressBar = elFile.querySelector('.progress')
      elFile._file = file //prevents loosing file handler?
    }
  }

  function uploadFiles(files) {

    function uploadFile(file) {
      file.progressBar.setAttribute('style', 'width: 0%;')
      file.progressBar.classList.remove('error')
      let path = $.query.path || '/'
      if (path[path.length-1] != '/') path += '/'
      path += file.filepath
      let href = form_upload.getAttribute('action') + '?path=' + path
      let aj = $.ajax(href)
      aj.xhr.upload.addEventListener('progress', function(e) {
        if (!e.lengthComputable) return
        let percent_upl = (e.loaded / e.total) * 100
        file.progressBar.setAttribute('style', 'width: '+ percent_upl +'%;')
      })
      let form_xhr = new FormData()
      form_xhr.append("files", file)
      aj.post(form_xhr)
        .then(dir => {
          file.progressBar.setAttribute('style', 'width: 100%;')
          file.progressBar.classList.add('success')
          //listDownloads(dir.files)
        }, err => {
          file.progressBar.classList.add('error')
          file.progressBar.setAttribute('style', 'width: 100%;')
        })
    }

    console.log('uploading files:', files)
    for (let file of files) { uploadFile(file) }
  }


  let form_upload = document.querySelector('form#upload')
  let input_files = form_upload.querySelector('input.files[type=file]')
  let input_directory = form_upload.querySelector('input.directory[type=file]')
  let uploads = [] //might be <input type="file"/>.files or dropped files

  input_files.addEventListener('change', ()=> {
    getFiles(input_files)
      .then(files => {
        uploads = uploads.concat(files)
        listUploads(uploads)
      })
  })
  input_directory.addEventListener('change', ()=> {
    getFiles(input_directory)
      .then(files => {
        uploads = uploads.concat(files)
        listUploads(uploads)
      })
  })
  form_upload.addEventListener('dragover', (e)=>{
    e.preventDefault()
    e.stopPropagation()
    form_upload.classList.add('dragover')
  })
  form_upload.addEventListener('dragleave', (e)=>{
    e.preventDefault()
    e.stopPropagation()
    form_upload.classList.remove('dragover')
  })
  form_upload.addEventListener('drop', (e)=>{
    e.preventDefault()
    e.stopPropagation()
    form_upload.classList.remove('dragover')
    getFiles(e.dataTransfer)
      .then(files => {
        uploads = uploads.concat(files)
        listUploads(uploads)
      })
  })
  form_upload.addEventListener('submit', (e)=>{
    e.preventDefault()
    e.stopPropagation()
    uploadFiles(uploads)
  })
}


function listDownloads(files) {
  let cont_downloads = $('#downloads')
  cont_downloads.innerHTML = ''
  for (let file of files) {
    console.log(file.href)
    let elFile = $.html(cont_downloads, `
      <div class="file">
        <div class="name">${file.isDirectory ? '['+file.name+']' : file.name}</div>
        <div class="size">${file.isDirectory ? '-' : file.size}</div>
        <div><a${file.isDirectory
          ? ' href="' + location.pathname.replace(/\/$/, '') + file.href.replace(/^[\w\W]*\?/, '/?')+'"'
          : ''}>view</a></div>
        <div><a${!file.isDirectory
          ? ' href="' + file.href+'"'
          : ' href="' + file.href.replace(/directory/, 'zip') + '"'}>download</a></div>
        <div class="delete"><a>delete</a></div>
      </div>
    `)
    $(elFile, '.delete').onclick = function () {
      console.log(file.href)
      $.ajax(file.href).delete().then(res => {
          console.log(res)
      })
    }
  }
}
